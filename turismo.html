<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
			crossorigin="anonymous"
		></script>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
			crossorigin="anonymous"
		/>

		<link rel="stylesheet" href="navbar.css" />
		<link rel="stylesheet" href="turismo.css" />
		<script src="https://d3js.org/d3.v4.js"></script>
		<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
	</head>
	<body>
		<nav class="navMenu">
			<a href="/index.html">Home</a>
			<a href="/alojamento.html">Alojamentos Turísticos</a>
			<a href="/ocupacao.html">Ocupação de Alojamentos Turísticos</a>
			<a href="/turismo.html" class="active"
				>Turismo da População Residente</a
			>
			<a href="/receitas.html">Receitas de Alojamentos Turísticos</a>
			<div id="dot"></div>
		</nav>

		<div class="container">
			<div class="row">
				<div class="col-6">
					<div class="title">
						<h1>População residente que viajou em turismo</h1>
					</div>
					<div class="subtitle">
						<h4>
							Onde há mais e menos pessoas a fazerem viagens
							turísticas, por faixas etárias
						</h4>
					</div>
				</div>
				<div class="col-6">
					<div class="title">
						<h1>
							População residente que viajou em turismo: total e
							por sexo
						</h1>
					</div>
					<div class="subtitle">
						<h4>
							Onde há, mais e menos, homens ou mulheres fazem
							viagens turísticas?
						</h4>
					</div>
				</div>
			</div>
			<div class="row filters">
				<div class="col-md-4">
					<select
						class="form-select"
						aria-label="Seleciona o ano"
						id="year-select"
					>
						<option selected value="2020" onclick="onSelect()">
							2020
						</option>
						<option value="2019" onclick="onSelect()">2019</option>
						<option value="2018">2018</option>
					</select>
				</div>
				<div class="col-md-4">
					<select
						class="form-select"
						aria-label="Seleciona a regiao"
						id="region-select"
					>
						<option
							value="files/viagens_grupo_etario_portugal.csv"
							selected
							onclick="onSelect()"
						>
							Portugal
						</option>
						<option
							value="files/viagens_grupo_etario_norte.csv"
							onclick="onSelect()"
						>
							Norte
						</option>
						<option value="Centro">Centro</option>
						<option value="Area">Area...</option>
					</select>
				</div>
				<div class="col-md-4">
					<button id="sort_button" class="btn btn-primary">
						Ordenar
					</button>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-6">
				<div class="graph container">
					<!-- Create a div where the graph will take place -->
					<div id="histogram_div"></div>
				</div>
			</div>
			<div class="col-6">
				<div class="graph container">
					<!-- Create a div where the graph will take place -->
					<div id="my_dataviz"></div>
				</div>
			</div>
		</div>
	</body>
	<script>
		//////////////////
		//	Histogram
		/////////////////
		// set the dimensions and margin_histograms of the graph
		var margin_histogram = { top: 30, right: 30, bottom: 70, left: 60 },
			width_histogram =
				460 - margin_histogram.left - margin_histogram.right,
			height_histogram =
				400 - margin_histogram.top - margin_histogram.bottom;

		// append the histogram_svg object to the body of the page
		var histogram_svg = d3
			.select("#histogram_div")
			.append("svg")
			.attr(
				"width",
				width_histogram + margin_histogram.left + margin_histogram.right
			)
			.attr(
				"height",
				height_histogram +
					margin_histogram.top +
					margin_histogram.bottom
			)
			.append("g")
			.attr(
				"transform",
				"translate(" +
					margin_histogram.left +
					"," +
					margin_histogram.top +
					")"
			);

		// Initialize the X axis
		var x = d3.scaleBand().range([0, width_histogram]);
		var xAxis = histogram_svg
			.append("g")
			.attr("transform", "translate(0," + height_histogram + ")");

		// Initialize the Y axis
		var y = d3.scaleLinear().range([height_histogram, 0]);
		var yAxis = histogram_svg.append("g").attr("class", "myYaxis");

		let sortOrder = false;
		/////////////////////////////////////////////////////////

		////////////////////////////////////////
		//	Stacked barplot with tooltip
		///////////////////////////////////////
		// set the dimensions and margins of the graph
		var margin = { top: 10, right: 30, bottom: 180, left: 50 },
			width = 460 - margin.left - margin.right,
			height = 500 - margin.top - margin.bottom;

		// append the svg object to the body of the page
		var svg = d3
			.select("#my_dataviz")
			.append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
			.append("g")
			.attr(
				"transform",
				"translate(" + margin.left + "," + margin.top + ")"
			);

		// Parse the Data
		d3.csv("files/viagens_por_genero_2020.csv", function (data) {
			// List of subgroups = header of the csv files = soil condition here
			var subgroups = data.columns.slice(1);

			// List of groups = species here = value of the first column called group -> I show them on the X axis
			var groups = d3
				.map(data, function (d) {
					return d.group;
				})
				.keys();

			// Add X axis
			var x = d3
				.scaleBand()
				.domain(groups)
				.range([0, width])
				.padding([0.2]);
			svg.append("g")
				.attr("transform", "translate(0," + height + ")")
				.attr("class", "myXaxis")
				.call(d3.axisBottom(x).tickSizeOuter(0));

			// Add Y axis
			var y = d3
				.scaleLinear()
				.domain([
					0,
					d3.max(data, function (d) {
						return (
							parseInt(d["Feminino"]) + parseInt(d["Masculino"])
						);
					}),
				])
				.range([height, 0]);
			svg.append("g").attr("class", "myYaxis").call(d3.axisLeft(y));

			console.log(
				d3.max(data, function (d) {
					return parseInt(d["Feminino"]) + parseInt(d["Masculino"]);
				})
			);

			// color palette = one color per subgroup
			var color = d3
				.scaleOrdinal()
				.domain(subgroups)
				.range(["#39CCCC", "#ff8da1"]);

			//stack the data? --> stack per subgroup
			var stackedData = d3.stack().keys(subgroups)(data);

			// ----------------
			// Create a tooltip
			// ----------------
			var tooltip = d3
				.select("#my_dataviz")
				.append("div")
				.style("opacity", 0)
				.attr("id", "stacked_tooltip")
				.attr("class", "tooltip")
				.style("background-color", "white")
				.style("border", "solid")
				.style("border-width", "1px")
				.style("border-radius", "5px")
				.style("padding", "10px");

			// Three function that change the tooltip when user hover / move / leave a cell
			var mouseover = function (d) {
				var subgroupName = d3.select(this.parentNode).datum().key;
				var subgroupValue = d.data[subgroupName];
				tooltip
					.html(
						"Genero: " +
							subgroupName +
							"<br>" +
							"Valor: " +
							subgroupValue
					)
					.style("opacity", 1);
			};
			var mousemove = function (d) {
				let pos = d3.select(this).node().getBoundingClientRect();

				tooltip
					.style("left", `${pos["x"] + 50}px`)
					.style("top", `${window.pageYOffset + pos["y"] - 50}px`);
			};
			var mouseleave = function (d) {
				tooltip.style("opacity", 0);
			};

			// Show the bars
			svg.append("g")
				.selectAll("g")
				// Enter in the stack data = loop key per key = group per group
				.data(stackedData)
				.enter()
				.append("g")
				.attr("id", "xd")
				.attr("fill", function (d) {
					return color(d.key);
				})
				.selectAll("rect")
				// enter a second time = loop subgroup per subgroup to add all rectangles
				.data(function (d) {
					return d;
				})
				.enter()
				.append("rect")
				.attr("x", function (d) {
					return x(d.data.group);
				})
				.attr("y", function (d) {
					return y(d[1]);
				})
				.attr("height", function (d) {
					return y(d[0]) - y(d[1]);
				})
				.attr("width", x.bandwidth())
				.attr("stroke", "grey")
				.on("mouseover", mouseover)
				.on("mousemove", mousemove)
				.on("mouseleave", mouseleave);
		});

		function update_bar_plot_stacked(filename) {
			d3.csv("files/" + filename, function (data) {
				// List of subgroups = header of the csv files = soil condition here
				var subgroups = data.columns.slice(1);

				// List of groups = species here = value of the first column called group -> I show them on the X axis
				var groups = d3
					.map(data, function (d) {
						return d.group;
					})
					.keys();

				// Add X axis
				var x = d3
					.scaleBand()
					.domain(groups)
					.range([0, width])
					.padding([0.2]);
				svg.selectAll("myXaxis")
					.attr("transform", "translate(0," + height + ")")
					.attr("class", "myXaxis")
					.call(d3.axisBottom(x).tickSizeOuter(0));

				// Add Y axis
				var y = d3
					.scaleLinear()
					.domain([
						0,
						d3.max(data, function (d) {
							return (
								parseInt(d["Feminino"]) +
								parseInt(d["Masculino"])
							);
						}),
					])
					.range([height, 0]);
				svg.select(".myYaxis").remove();
				svg.append("g").attr("class", "myYaxis").call(d3.axisLeft(y));

				// color palette = one color per subgroup
				var color = d3
					.scaleOrdinal()
					.domain(subgroups)
					.range(["#39CCCC", "#ff8da1"]);

				//stack the data? --> stack per subgroup
				var stackedData = d3.stack().keys(subgroups)(data);

				var tooltip = d3.select("#stacked_tooltip");

				// Three function that change the tooltip when user hover / move / leave a cell
				var mouseover = function (d) {
					var subgroupName = d3.select(this.parentNode).datum().key;
					var subgroupValue = d.data[subgroupName];
					tooltip
						.html(
							"subgroup: " +
								subgroupName +
								"<br>" +
								"Value: " +
								subgroupValue
						)
						.style("opacity", 1);
				};
				var mousemove = function (d) {
					let pos = d3.select(this).node().getBoundingClientRect();

					tooltip
						.style("left", `${pos["x"] + 50}px`)
						.style(
							"top",
							`${window.pageYOffset + pos["y"] - 100}px`
						);
				};
				var mouseleave = function (d) {
					tooltip.style("opacity", 0);
				};

				svg.selectAll("rect").remove();

				svg.append("g")
					.selectAll("g")
					// Enter in the stack data = loop key per key = group per group
					.data(stackedData)
					.enter()
					.append("g")
					.attr("fill", function (d) {
						return color(d.key);
					})
					.selectAll("rect")
					// enter a second time = loop subgroup per subgroup to add all rectangles
					.data(function (d) {
						return d;
					})
					.enter()
					.append("rect")
					.attr("x", function (d) {
						return x(d.data.group);
					})
					.attr("y", function (d) {
						return y(d[1]);
					})
					.attr("height", function (d) {
						return y(d[0]) - y(d[1]);
					})
					.attr("width", x.bandwidth())
					.attr("stroke", "grey")
					.on("mouseover", mouseover)
					.on("mousemove", mousemove)
					.on("mouseleave", mouseleave);
			});
		}
		/////////////

		// A function that create / update_histogram the plot for a given variable:
		function update_histogram(selectedVar, filename, sortOrder) {
			// Parse the Data
			d3.csv(filename, function (data) {
				if (sortOrder != undefined) {
					data.sort((a, b) => {
						if (sortOrder) {
							return d3.ascending(a[selectedVar], b[selectedVar]);
						} else {
							return d3.descending(
								a[selectedVar],
								b[selectedVar]
							);
						}
					});
				}

				// X axis
				x.domain(
					data.map(function (d) {
						return d.group;
					})
				);
				xAxis.transition().duration(1000).call(d3.axisBottom(x));

				// Add Y axis
				y.domain([
					0,
					d3.max(data, function (d) {
						return +d[selectedVar];
					}),
				]);
				yAxis.transition().duration(1000).call(d3.axisLeft(y));

				// variable u: map data to existing bars
				var u = histogram_svg.selectAll("rect").data(data);

				// update_histogram bars
				u.enter()
					.append("rect")
					.merge(u)
					.transition()
					.duration(1000)
					.attr("x", function (d) {
						return x(d.group);
					})
					.attr("y", function (d) {
						return y(d[selectedVar]);
					})
					.attr("width", x.bandwidth())
					.attr("height", function (d) {
						return height_histogram - y(d[selectedVar]);
					})
					.attr("fill", "#69b3a2");
			});
		}

		d3.select("#sort_button").on("click", function (e, d) {});

		function onSelect(filename) {
			var year = document.getElementById("year-select").value;
			var region = document.getElementById("region-select").value;
			update_histogram(year, region, undefined);
			update_bar_plot_stacked("viagens_por_genero_" + year + ".csv");
		}

		// Initialize plot
		update_histogram(
			"2020",
			"files/viagens_grupo_etario_portugal.csv",
			undefined
		);
	</script>
</html>
