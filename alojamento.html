<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
		<script type="text/javascript" src="http://d3js.org/d3.v6.js"></script>
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
			crossorigin="anonymous"
		></script>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
			crossorigin="anonymous"
		/>
		<link rel="stylesheet" href="alojamento.css" />
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<!-- TODO -->
	</head>
	<body>
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container-fluid">
				<a class="navbar-brand" href="index.html">Navbar</a>
				<button
					class="navbar-toggler"
					type="button"
					data-bs-toggle="collapse"
					data-bs-target="#navbarSupportedContent"
					aria-controls="navbarSupportedContent"
					aria-expanded="false"
					aria-label="Toggle navigation"
				>
					<span class="navbar-toggler-icon"></span>
				</button>
				<div
					class="collapse navbar-collapse"
					id="navbarSupportedContent"
				>
					<ul class="navbar-nav me-auto mb-2 mb-lg-0">
						<li class="nav-item">
							<a
								class="nav-link"
								aria-current="page"
								href="/index.html"
								>Home</a
							>
						</li>
						<li class="nav-item">
							<a class="nav-link active" href="/alojamento.html"
								>Alojamento</a
							>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="/despesas.html"
								>Despesas</a
							>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<div class="container">
			<div class="title">
				<h1>População residente que viajou em turismo</h1>
			</div>
			<div class="subtitle">
				<h4>
					Onde há mais e menos pessoas a fazerem viagens turísticas,
					por faixas etárias?
				</h4>
			</div>
		</div>

		<div class="container graph">
			<div class="row filters">
				<div class="col-md-4">
					<div class="dropdown">
						<button
							class="btn btn-secondary dropdown-toggle"
							type="button"
							id="dropdownMenuButton1"
							data-bs-toggle="dropdown"
							aria-expanded="false"
						>
							Ano
						</button>
						<ul
							class="dropdown-menu"
							id="dropdownMenuButton1"
							aria-labelledby="dropdownMenuButton1"
						>
							<li><a class="dropdown-item" href="#">2020</a></li>
							<li><a class="dropdown-item" href="#">2019</a></li>
							<li><a class="dropdown-item" href="#">2018</a></li>
						</ul>
					</div>
				</div>
				<div class="col-md-4">
					<div class="dropdown">
						<button
							class="btn btn-secondary dropdown-toggle"
							type="button"
							id="dropdownMenuButton2"
							data-bs-toggle="dropdown"
							aria-expanded="false"
						>
							Regiao
						</button>
						<ul
							class="dropdown-menu"
							id="dropdownMenuButton2"
							aria-labelledby="dropdownMenuButton2"
						>
							<li>
								<a class="dropdown-item" href="#">Norte</a>
							</li>
							<li>
								<a class="dropdown-item" href="#">Centro</a>
							</li>
							<li>
								<a class="dropdown-item" href="#">Area ...</a>
							</li>
						</ul>
					</div>
				</div>
				<div class="col-md-4">
					<button id="sort_button" class="btn btn-primary">
						Ordenar
					</button>
				</div>
			</div>
			<!-- <div id="div_d3" style="text-align: center"></div> -->
			<svg width="600" height="500"></svg>
		</div>
	</body>

	<script>
		function create_bar_chart(filename) {
			d3.csv(filename, function (error, data) {
				if (error) {
					throw error;
				}

				var svg = d3.select("svg"),
					margin = 200,
					width = svg.attr("width") - margin,
					height = svg.attr("height") - margin;

				var xScale = d3.scaleBand().range([0, width]).padding(0.4),
					yScale = d3.scaleLinear().range([height, 0]);

				var svg = svg
					.append("g")
					.attr("transform", "translate(" + 100 + "," + 60 + ")");

				xScale.domain(
					data.map(function (d) {
						return d.group;
					})
				);
				yScale.domain([
					0,
					d3.max(data, function (d) {
						return parseInt(d.value);
					}),
				]);

				svg.append("g")
					.attr("transform", "translate(0," + height + ")")
					.call(d3.axisBottom(xScale))
					.append("text")
					.attr("y", height - 250)
					.attr("x", width - 100)
					.attr("text-anchor", "end")
					.attr("stroke", "black")
					.text("Grupos Etarios");

				svg.append("g")
					.call(
						d3
							.axisLeft(yScale)
							.tickFormat(function (d) {
								return d;
							})
							.ticks(10)
					)
					.append("text")
					.attr("transform", "rotate(-90)")
					.attr("y", 6)
					.attr("dy", "-5.1em")
					.attr("text-anchor", "end")
					.attr("stroke", "black")
					.text("Hóspedes - Milhares");

				svg.selectAll(".bar")
					.data(data)
					.enter()
					.append("rect")
					.attr("class", "bar")
					.attr("x", function (d) {
						return xScale(d.group);
					})
					.attr("y", function (d) {
						return yScale(d.value);
					})
					.attr("width", xScale.bandwidth())
					.attr("height", function (d) {
						return height - yScale(d.value);
					});

				svg.selectAll(".bar-title")
					.data(data)
					.enter()
					.append("text")
					.classed("bar-title", true)
					.attr("text-anchor", "middle")
					.attr("x", (d) => xScale(d.group) + xScale.bandwidth() / 2)
					.attr("y", (d) => yScale(d.value) - 5)
					.text((d) => `${d.value}`);

				//Define sort order flag
				let sortOrder = false;

				//Define sort function
				let sortBars = function () {
					//Flip value of sortOrder
					sortOrder = !sortOrder;

					data.sort(function (a, b) {
						if (sortOrder) {
							//return d3.ascending(a.value, b.value);
							return a.value - b.value;
						} else {
							//return d3.descending(a.value, b.value);
							return a.value + b.value;
						}
					});
					xScale.domain(
						data.map(function (d) {
							return d.group;
						})
					);
					svg.selectAll("svg g").remove();

					svg.append("g")
						.attr("transform", "translate(0," + height + ")")
						.call(d3.axisBottom(xScale))
						.append("text")
						.attr("y", height - 250)
						.attr("x", width - 100)
						.attr("text-anchor", "end")
						.attr("stroke", "black")
						.text("Grupos Etarios");

					svg.append("g")
						.call(
							d3
								.axisLeft(yScale)
								.tickFormat(function (d) {
									return d;
								})
								.ticks(10)
						)
						.append("text")
						.attr("transform", "rotate(-90)")
						.attr("y", 6)
						.attr("dy", "-5.1em")
						.attr("text-anchor", "end")
						.attr("stroke", "black")
						.text("Hóspedes - Milhares");

					svg.selectAll(".bar")
						.data(data)
						.transition(d3.easeCircle)
						.delay(100)
						.attr("x", function (d) {
							return xScale(d.group);
						})
						.attr("y", function (d) {
							return yScale(d.value);
						})
						.attr("width", xScale.bandwidth())
						.attr("height", function (d) {
							return height - yScale(d.value);
						});

					svg.selectAll("svg .bar-title").remove();
					svg.selectAll(".bar-title")
						.data(data)
						.enter()
						.append("text")
						.classed("bar-title", true)
						.attr("text-anchor", "middle")
						.attr(
							"x",
							(d) => xScale(d.group) + xScale.bandwidth() / 2
						)
						.attr("y", (d) => yScale(d.value) - 5)
						.text((d) => `${d.value}`);
				};
				d3.select("#sort_button").on("click", function (e, d) {
					sortBars();
				});
			});
		}

		create_bar_chart("files/viagens_grupo_etario_2020.csv");
	</script>
	<script type="text/javascript">
		// Update dropdowns text
		$("#dropdownMenuButton2 li a").click(function () {
			var selText = $(this).text();
			$("#dropdownMenuButton2").html(selText);
			create_bar_chart("files/viagens_grupo_etario_" + selText + ".csv");
		});
		$("#dropdownMenuButton1 li a").click(function () {
			var selText = $(this).text();
			$("#dropdownMenuButton1").html(selText);
			create_bar_chart("files/viagens_grupo_etario_" + selText + ".csv");
		});
	</script>
</html>
