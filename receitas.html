<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title></title>
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
			crossorigin="anonymous"
		></script>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
			crossorigin="anonymous"
		/>
		<script src="https://d3js.org/d3.v4.js"></script>
		<link rel="stylesheet" href="receitas.css" />
	</head>

	<body>
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container-fluid">
				<a class="navbar-brand" href="index.html">Navbar</a>
				<button
					class="navbar-toggler"
					type="button"
					data-bs-toggle="collapse"
					data-bs-target="#navbarSupportedContent"
					aria-controls="navbarSupportedContent"
					aria-expanded="false"
					aria-label="Toggle navigation"
				>
					<span class="navbar-toggler-icon"></span>
				</button>
				<div
					class="collapse navbar-collapse"
					id="navbarSupportedContent"
				>
					<ul class="navbar-nav me-auto mb-2 mb-lg-0">
						<li class="nav-item">
							<a
								class="nav-link"
								aria-current="page"
								href="/index.html"
								>Home</a
							>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="/alojamento.html"
								>Alojamento</a
							>
						</li>
						<li class="nav-item">
							<a class="nav-link active" href="/receitas.html"
								>Receitas</a
							>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="/despesas.html"
								>Despesas</a
							>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<div class="container">
			<div class="title">
				<h1>
					Proveitos com dormidas nos alojamentos turísticos: total e
					por tipo de estabelecimento
				</h1>
			</div>
			<div class="subtitle">
				<h4>
					Quanto é o rendimento obtido com dormidas pelos hotéis,
					apartamentos, aldeamentos turísticos, pelo turismo de
					habitação, pelo turismo rural ou pelo alojamento local?
				</h4>
			</div>
		</div>

		<div class="container graph">
			<div class="row filters">
				<div class="col-md-4">
					<select
						class="form-select"
						aria-label="Seleciona o ano"
						id="year-select"
					>
						<option selected value="2020" onclick="onSelect()">
							2020
						</option>
						<option value="2019" onclick="onSelect()">2019</option>
						<option value="2018">2018</option>
					</select>
				</div>
				<div class="col-md-4">
					<select
						class="form-select"
						aria-label="Seleciona a regiao"
						id="region-select"
					>
						<option
							value="files/receitas_alojamento_portugal.csv"
							selected
							onclick="onSelect()"
						>
							Portugal
						</option>
						<option value="" onclick="onSelect()">Norte</option>
						<option value="Centro">Centro</option>
						<option value="Area">Area...</option>
					</select>
				</div>
				<div class="col-md-4">
					<button id="sort_button" class="btn btn-primary">
						Ordenar
					</button>
				</div>
			</div>

			<!-- Create a div where the graph will take place -->
			<div class="row">
				<div id="linechart_div" class="col-9"></div>
				<div class="col-3 checkboxes">
					<div class="form-check">
						<input
							class="form-check-input"
							type="checkbox"
							value=""
							id="total"
							onclick="update_linechart('total')"
							checked
						/>
						<label class="form-check-label" for="total">
							Total
						</label>
					</div>
					<div class="form-check">
						<input
							class="form-check-input"
							type="checkbox"
							value=""
							id="hotel"
							onclick="update_linechart('hotel')"
						/>
						<label class="form-check-label" for="hotel">
							Hoteis
						</label>
					</div>
					<div class="form-check">
						<input
							class="form-check-input"
							type="checkbox"
							value=""
							id="hotel-apartamentos"
							onclick="update_linechart('hotel-apartamentos')"
						/>
						<label
							class="form-check-label"
							for="hotel-apartamentos"
						>
							Hoteis-Apartamentos
						</label>
					</div>
					<div class="form-check">
						<input
							class="form-check-input"
							type="checkbox"
							value=""
							id="-QWEFRWEFWEFWE"
							onclick="update_linechart('hWEFWentos')"
						/>
						<label class="form-check-label" for="EFWEFWEFWEFs">
							add more
						</label>
					</div>
				</div>
			</div>

			<div id="barplot_div"></div>
		</div>
	</body>
	<script>
		/////////////////
		//  Line chart
		////////////////

		// set the dimensions and margins of the graph
		var line_chart_margin = { top: 10, right: 30, bottom: 30, left: 70 },
			line_chart_width =
				800 - line_chart_margin.left - line_chart_margin.right,
			line_chart_height =
				400 - line_chart_margin.top - line_chart_margin.bottom;

		// append the svg object to the body of the page
		var line_chart_svg = d3
			.select("#linechart_div")
			.append("svg")
			.attr(
				"width",
				line_chart_width +
					line_chart_margin.left +
					line_chart_margin.right
			)
			.attr(
				"height",
				line_chart_height +
					line_chart_margin.top +
					line_chart_margin.bottom
			)
			.append("g")
			.attr(
				"transform",
				"translate(" +
					line_chart_margin.left +
					"," +
					line_chart_margin.top +
					")"
			);

		//Read the data
		d3.csv(
			"files/receitas_alojamento_portugal_line.csv",
			// Now I can use this dataset:
			function (data) {
				var x = d3
					.scalePoint()
					.domain(
						data.map(function (d) {
							return d.date;
						})
					)
					.range([0, line_chart_width]);

				line_chart_svg
					.append("g")
					.attr("transform", "translate(0," + line_chart_height + ")")
					.call(d3.axisBottom(x))
					.attr("class", "myXaxis_line");

				// Add Y axis
				var y = d3
					.scaleLinear()
					.domain([
						0,
						d3.max(data, function (d) {
							return +d.total;
						}),
					])
					.range([line_chart_height, 0]);
				line_chart_svg.append("g").call(d3.axisLeft(y));

				lines = {
					total: "black",
					hotel: "blue",
					"hotel-apartamentos": "green",
				};

				for (const key in lines) {
					// Add the line
					line_chart_svg
						.append("path")
						.datum(data)
						.attr("id", key + "_")
						.attr("fill", "none")
						.attr("stroke", "steelblue")
						.attr("stroke-width", 2)
						.attr("opacity", 0)
						.attr("stroke", lines[key])
						.attr(
							"d",
							d3
								.line()
								.x(function (d) {
									return x(d.date);
								})
								.y(function (d) {
									return y(d[key]);
								})
						);
				}
				// Draw total line at start
				var total = d3.select("#total_");
				total.attr("opacity", 1);

				// This allows to find the closest X index of the mouse:
				var bisect = d3.bisector(function (d) {
					return d.total;
				}).left;

				// Create the circle that travels along the curve of chart
				var focus = line_chart_svg
					.append("g")
					.append("circle")
					.style("fill", "none")
					.attr("stroke", "black")
					.attr("r", 8.5)
					.style("opacity", 0);

				// Create the text that travels along the curve of chart
				var focusText = line_chart_svg
					.append("g")
					.append("text")
					.style("opacity", 0)
					.attr("text-anchor", "left")
					.attr("alignment-baseline", "middle");

				line_chart_svg
					.append("rect")
					.style("fill", "none")
					.style("pointer-events", "all")
					.attr("width", line_chart_width)
					.attr("height", line_chart_height)
					.on("mouseover", mouseover)
					.on("mousemove", mousemove)
					.on("mouseout", mouseout);

				// What happens when the mouse move -> show the annotations at the right positions.
				function mouseover() {
					focus.style("opacity", 1);
					focusText.style("opacity", 1);
				}

				function mousemove() {
					var xx = d3.scaleTime().range([0, line_chart_width]);
					console.log(d3.mouse(this))
					console.log(xx)
					// recover coordinate we need
					var x0 = xx.invert(d3.mouse(this)[0]);
					console.log(x0, "Wefwefe")
					/* var i = bisect(data, x0, 1);
					selectedData = data[i];
					focus
						.attr("cx", x(selectedData.x))
						.attr("cy", y(selectedData.y));
					focusText
						.html("OLAAA")
						.attr("x", x(selectedData.x) + 15)
						.attr("y", y(selectedData.y)); */
				}
				function mouseout() {
					focus.style("opacity", 0);
					focusText.style("opacity", 0);
				}
			}
		);

		function update_linechart(checkboxid) {
			var checkbox_elem = document.getElementById(checkboxid).checked;
			var svgline = d3.select("#" + checkboxid + "_");

			if (checkbox_elem) {
				svgline.attr("opacity", 1);
			} else {
				svgline.attr("opacity", 0);
			}
		}

		/////////////////
		//  BAR PLOT
		////////////////

		// set the dimensions and margins of the graph
		var margin = { top: 30, right: 30, bottom: 70, left: 70 },
			width = 500 - margin.left - margin.right,
			height = 400 - margin.top - margin.bottom;

		// append the svg object to the body of the page
		var svg = d3
			.select("#barplot_div")
			.append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
			.append("g")
			.attr(
				"transform",
				"translate(" + margin.left + "," + margin.top + ")"
			);

		// Initialize the X axis
		var x = d3.scaleBand().range([0, width]).padding(0.2);
		var xAxis = svg
			.append("g")
			.attr("transform", "translate(0," + height + ")")
			.attr("class", "myXaxis");

		// Initialize the Y axis
		var y = d3.scaleLinear().range([height, 0]);
		var yAxis = svg.append("g").attr("class", "myYaxis");

		let sortOrder = true;

		// A function that create / update_bar the plot for a given variable:
		function update_bar(selectedVar, filename, sortOrder) {
			// Parse the Data
			d3.csv(filename, function (data) {
				if (sortOrder != undefined) {
					data.sort((a, b) => {
						if (sortOrder) {
							return d3.ascending(
								parseInt(a[selectedVar]),
								parseInt(b[selectedVar])
							);
						} else {
							return d3.descending(
								parseInt(a[selectedVar]),
								parseInt(b[selectedVar])
							);
						}
					});
				}

				// X axis
				x.domain(
					data.map(function (d) {
						return d.type;
					})
				);
				xAxis.transition().duration(1000).call(d3.axisBottom(x));

				// Add Y axis
				y.domain([
					0,
					d3.max(data, function (d) {
						return +d[selectedVar];
					}),
				]);
				yAxis.transition().duration(1000).call(d3.axisLeft(y));

				// variable u: map data to existing bars
				var u = svg.selectAll("rect").data(data);

				// update_bar bars
				u.enter()
					.append("rect")
					.merge(u)
					.transition()
					.duration(1000)
					.attr("x", function (d) {
						return x(d.type);
					})
					.attr("y", function (d) {
						return y(d[selectedVar]);
					})
					.attr("width", x.bandwidth())
					.attr("height", function (d) {
						return height - y(d[selectedVar]);
					})
					.attr("fill", "#69b3a2");
			});
		}

		d3.select("#sort_button").on("click", function (e, d) {
			console.log("SORTING ACTIVATED");
			var year = document.getElementById("year-select").value;
			var region = document.getElementById("region-select").value;

			console.log("year", year);
			console.log("sort order: ", sortOrder);

			sortOrder = !sortOrder;
			update_bar(year, region, sortOrder);
		});

		function onSelect() {
			var year = document.getElementById("year-select").value;
			var region = document.getElementById("region-select").value;
			update_bar(year, region, undefined);
		}

		// Initialize plot
		update_bar("2020", "files/receitas_alojamento_portugal.csv", undefined);
	</script>
</html>
